# Loop Context

## Operating constraints
- One loop cycle performs one atomic step only.
- Never skip writing run output to `loop_state.json`.
- Require proof on every run (log snippet, command output, diff summary, or test line).
- Keep changes minimal, reversible, and production-safe.

## Rules
- Pick next actionable task from `tasks.md` with status `todo` and no blockers.
- Move a task to `in_progress` only for the current cycle.
- End cycle by setting task to `done`, `todo` (if partial), or `blocked`.
- Increment retry counters only on failed cycles.

## Common pitfalls
- Doing multiple steps in one cycle (breaks atomicity).
- Failing to capture proof.
- Forgetting to reset failure counters after a successful run.
- Escalating too early (before retry threshold) or too late (after threshold).

## Latest cycle log
- 2026-02-27 10:16Z — Task #20 (follow graph minimal): étape atomique livrée — support des `following` string étendu au séparateur `;` en plus de `,` et nouvelle ligne via `split(/[\n,;]+/)`, pour préserver les edges sur payloads upstream hétérogènes. Validation: `node --check server.js` PASS + `grep -nF "split(/[\n,;]+/)" server.js`. Proof: commit `65451e2`.
- 2026-02-27 10:15Z — Task #20 (follow graph minimal): étape atomique livrée — parsing `agent.following` string élargi au séparateur tabulation `\t` (en plus virgule/point-virgule/nouvelle ligne) pour conserver les edges sur payloads upstream mixtes. Validation: `node --check server.js` PASS + `grep -nF "split(/[\n,;\t]+/)" server.js`. Proof: commit `<pending>`.
- 2026-02-27 10:02Z — Task #20 (follow graph minimal): étape atomique livrée — index `nodeByHandle` rendu déterministe en triant d’abord les nœuds par nom puis stratégie "first-handle-wins" (`reduce` + garde `acc.has(handleKey)`), pour éviter l’écrasement silencieux d’un mapping handle avec des données dupliquées et dépendantes de l’ordre d’insertion. Validation: `node --check server.js` PASS + `grep -n "nodeByHandle = nodes\|sort((a, b) => a.name.localeCompare" server.js`. Proof: commit `5541a15`.
- 2026-02-27 10:15Z — Task #20 (follow graph minimal): étape atomique livrée — support des `following` au format string (séparateurs virgule/nouvelle ligne) en plus des tableaux, pour préserver la génération d’edges quand la source upstream n’envoie pas un array strict. Validation: `node --check server.js` PASS + `grep -n "followingRaw\|split(/[\n,]+/)" server.js`. Proof: commit `b1e5570`.
- 2026-02-27 10:00Z — Task #20 (follow graph minimal): étape atomique livrée — tri déterministe des `verifiedEntries` par nom canonique (`agent.name` fallback clé) avant construction du graphe, pour stabiliser la résolution des nœuds/edges (notamment collisions de handles) indépendamment de l’ordre d’insertion objet. Validation: `node --check server.js` PASS + `grep -n "canonicalA\|canonicalB" server.js`. Proof: commit `7768c6c`.
- 2026-02-27 09:45Z — Task #20 (follow graph minimal): étape atomique livrée — résolution du nœud source renforcée: priorité à la clé canonique dérivée de `agent.name` (`normalizedFromAgentNameKey`) avec fallback sur la clé map (`normalizedFromNameKey`), pour éviter pertes d’edges si les clés `agents` divergent du nom canonique. Validation: `node --check server.js` PASS + `grep -n "normalizedFromAgentNameKey\|sourceLookupKey" server.js`. Proof: commit `874237d`.
- 2026-02-27 09:00Z — Task #20 (follow graph minimal): étape atomique livrée — résolution canonique du nœud source (`normalizedFromNameKey` → `fromNode`) et émission des edges via `canonicalFromName`, pour stabiliser self-loop/déduplication quand les clés `agents` varient en casse/espaces. Validation: `node --check server.js` PASS + `grep -n "canonicalFromName\|normalizedFromNameKey" server.js`. Proof: commit `cc3c03f`.
- 2026-02-27 08:45Z — Task #20 (follow graph minimal): étape atomique livrée — décodage robuste des cibles `following` percent-encodées (`%40handle`, URLs encodées) via `decodeURIComponent` protégé par `try/catch` avant extraction `targetToken`, afin de conserver les edges même quand la source upstream encode les valeurs. Validation: `node --check server.js` PASS + `grep -n "decodeURIComponent\|targetToken" server.js`. Proof: commit `0fbfc5d`.
- 2026-02-27 08:30Z — Task #20 (follow graph minimal): étape atomique livrée — normalisation des cibles `following` étendue aux URLs X/Twitter (`https://x.com/<handle>`, `twitter.com/<handle>`) avant résolution nom/handle, pour éviter la perte d’edges quand les données upstream stockent des URLs complètes. Validation: `node --check server.js` PASS + `grep -n "targetToken" server.js`. Proof: commit `<pending>`.
- 2026-02-27 08:15Z — Task #20 (follow graph minimal): étape atomique livrée — hardening résolution des cibles follow graph: index `nodeByName` normalisé via `String(node.name || '').trim().toLowerCase()` avec filtre des clés vides, pour fiabiliser le matching des `following` malgré espaces parasites dans les noms agents. Validation: `node --check server.js` PASS + `grep -n "String(node.name || '')" server.js`. Proof: commit `<pending>`.
- 2026-02-27 08:00Z — Task #20 (follow graph minimal): étape atomique livrée — normalisation stricte de `live_status` dans `GET /api/agents/follow-graph` pour ne conserver que `live|stale|offline`; toute valeur inattendue est forcée à `offline` afin de stabiliser le contrat UI. Validation: `node --check server.js` PASS. Proof: commit `ee6fc6b`.
- 2026-02-27 07:45Z — Task #20 (follow graph minimal): étape atomique livrée — sortie API follow graph rendue déterministe en triant `nodes` par `name` et `edges` par `from/to` avant réponse JSON, pour stabiliser consommation UI/caching/diffs. Validation: `node --check server.js` PASS. Proof: commit `bb7238a`.
- 2026-02-27 07:30Z — Task #20 (follow graph minimal): étape atomique livrée — ajout endpoint API minimal `GET /api/agents/follow-graph` (nodes agents vérifiés + edges dédupliquées depuis `agent.following` avec résolution par nom/handle), prêt pour brancher la UI graphe dans les prochains cycles. Validation: `node --check server.js` PASS + `grep -n "api/agents/follow-graph" server.js`. Proof: commit `9bca40f`.
- 2026-02-27 07:15Z — Task #19 (profile/projects production-ready): no-op contrôlé + ESCALADE. Trois cycles consécutifs sans delta atomique sûr; task marquée `blocked` et bascule vers #20 au prochain cycle. Validation: `grep -n "canonicalAgentName\|encodedAgentName\|followCtaHtml" server.js` + `node --check server.js` PASS. Proof: explicit no-op with reason.
- 2026-02-27 07:00Z — Task #19 (profile/projects production-ready): no-op contrôlé; audit de clôture relancé, aucun delta atomique sûr supplémentaire identifié sans élargir le scope “production-ready”. Validation: `grep -n "canonicalAgentName\|encodedAgentName\|followCtaHtml" server.js` (lignes 846/847/855/902/923/1142/1145/1148) + `node --check server.js` PASS. Proof: explicit no-op with reason.
- 2026-02-27 06:45Z — Task #19 (profile/projects production-ready): hardening robustesse des liens/profile en adoptant le nom agent canonique résolu (`agent.name`) pour `safeAgentName` et `encodedAgentName`, afin d’éviter les liens incohérents quand le paramètre URL contient casse/espaces variants. Validation: `node --check server.js` PASS. Proof: commit `0e38e96`.
- 2026-02-27 06:30Z — Task #19 (profile/projects production-ready): durcissement anti-perte de précision IEEE-754 sur parsing followers; ajout garde `normalizedFollowerCountRaw.length > 15` pour clamp direct à `Number.MAX_SAFE_INTEGER` avant formatage. Validation: `node --check server.js` PASS. Proof: commit `71711b3`.
- 2026-02-27 06:00Z — Task #19 (profile/projects production-ready): durcissement parsing followers en numérique strict (`^\d+$`) après normalisation séparateurs; formats ambigus (`1e3`, `0x10`, suffixes texte) désormais rejetés vers fallback `0`. Validation: `node --check server.js` PASS. Proof: commit `<pending>`.
- 2026-02-27 06:00Z — Task #19 (profile/projects production-ready): hardened follower-count robustness by flooring parsed numeric value to an integer before display formatting, preventing fractional follower values from leaking into UI logic. Validation: `node --check server.js` PASS. Proof: git commit hash.
- 2026-02-27 05:45Z — Task #19 (profile/projects production-ready): no-op contrôlé; aucun delta atomique sûr supplémentaire identifié sans élargir le scope. Validation: `grep -n "normalizedFollowerCountRaw" server.js` (lines 876-877) + `node --check server.js` PASS. Proof: explicit no-op with reason.
- 2026-02-27 05:30Z — Task #19 (profile/projects production-ready): hardened followers parsing by normalizing common string formats (`1,234`, `1_234`, spaced values) before numeric conversion, preventing false fallback to `0` on valid inputs. Validation: `node --check server.js` PASS. Proof: commit `d6100fa`.
- 2026-02-27 05:15Z — Task #19 (profile/projects production-ready): extended compact follower display with `B` suffix for values >=1,000,000,000 while preserving existing `M`/`K`/integer thresholds. Validation: `node --check server.js` PASS. Proof: commit `778a9ab`.
- 2026-02-27 04:45Z — Task #19 (profile/projects production-ready): extended follower count display for high-volume profiles by adding `M` suffix for values >=1,000,000 while preserving integer (<1000) and `x.xK` (>=1000) formats. Validation: `node --check server.js` PASS. Proof: commit `e6818c1`.
- 2026-02-27 04:30Z — Task #19 (profile/projects production-ready): improved followers metric rendering on profile page by removing misleading `K` suffix for values below 1000 while keeping `x.xK` for >=1000. Validation: `node --check server.js` PASS. Proof: commit `2e86442`.
- 2026-02-27 03:45Z — Task #19 (profile/projects production-ready): no-op contrôlé; audit ciblé relancé, aucun delta atomique sûr supplémentaire identifié sans sortir du scope courant. Validation: `grep -n "liveStatus" server.js` (aucune occurrence legacy, exit=1 attendu) + `grep -n "normalizedLiveStatus" server.js` (lignes 860/861/862/1037/1139) + `node --check server.js` PASS.
- 2026-02-27 03:30Z — Task #19 (profile/projects production-ready): no-op contrôlé; aucun delta sûr/utile additionnel identifié après le correctif 03:16Z. Validation: `grep -n "liveStatus" server.js` (aucune référence legacy) + `grep -n "normalizedLiveStatus" server.js` (lignes 860/861/862/1037/1139) + `node --check server.js` PASS.
- 2026-02-27 03:16Z — Task #19 (profile/projects production-ready): correction atomique de robustesse sur page profile; remplacement de `liveStatus` (variable template non définie) par `normalizedLiveStatus` sur les 2 indicateurs visuels de statut, évitant rendu cassé/ReferenceError. Validation: `node --check server.js` PASS.
## Cycle log
- 2026-02-27T10:16:10Z — Task #20 (follow graph minimal): delivered one atomic step by extending string parsing of `agent.following` to include semicolon-separated values in addition to comma/newline (`split(/[\n,;]+/)`), preserving edge extraction when upstream payloads use semicolon-delimited lists. Validation: `node --check server.js` PASS + `grep -nF "split(/[\n,;]+/)" server.js`. Proof: commit `<pending>`.
- 2026-02-27T10:15:37Z — Task #20 (follow graph minimal): delivered one atomic step by expanding string `following` tokenization to include tab separators (`\t`) in addition to comma/semicolon/newline, preserving follow edges when upstream emits mixed-delimiter lists. Validation: `node --check server.js` PASS + `grep -nF "split(/[\n,;\t]+/)" server.js`. Proof: commit `<pending>`.
- 2026-02-27T10:02:00Z — Task #20 (follow graph minimal): delivered one atomic step by making `nodeByHandle` deterministic through name-sorted node traversal followed by first-handle-wins reduction (`acc.has(handleKey)` guard), preventing silent overwrite from duplicate handles tied to insertion order variance. Validation: `node --check server.js` PASS + `grep -n "nodeByHandle = nodes\|sort((a, b) => a.name.localeCompare" server.js`. Proof: commit `5541a15`.
- 2026-02-27T10:00:00Z — Task #20 (follow graph minimal): delivered one atomic step by sorting verified source entries by canonical name (`agent.name` fallback object key) before graph construction, making node/edge resolution deterministic regardless of object insertion order. Validation: `node --check server.js` PASS + `grep -n "canonicalA\|canonicalB" server.js`. Proof: commit `7768c6c`.
- 2026-02-27T09:45:00Z — Task #20 (follow graph minimal): delivered one atomic step by prioritizing source-node resolution with canonical `agent.name` key (`normalizedFromAgentNameKey`) and falling back to map key (`normalizedFromNameKey`), preventing dropped/misaligned edges when object keys diverge from canonical identity naming. Validation: `node --check server.js` PASS + `grep -n "normalizedFromAgentNameKey\|sourceLookupKey" server.js`. Proof: commit `874237d`.
- 2026-02-27T09:00:00Z — Task #20 (follow graph minimal): delivered one atomic step by resolving source agents through canonical keys (`normalizedFromNameKey` → `fromNode`) and emitting edges with `canonicalFromName`, preventing self-loop/dedup inconsistencies when source keys differ by casing/whitespace. Validation: `node --check server.js` PASS + `grep -n "canonicalFromName\|normalizedFromNameKey" server.js`. Proof: commit `cc3c03f`.
- 2026-02-27T08:45:00Z — Task #20 (follow graph minimal): delivered one atomic step by decoding percent-encoded follow targets (e.g., `%40handle`, encoded X/Twitter URLs) with guarded `decodeURIComponent` before `targetToken` normalization, preserving edge resolution when upstream stores URL-encoded values. Validation: `node --check server.js` PASS + `grep -n "decodeURIComponent\|targetToken" server.js`. Proof: commit `0fbfc5d`.
- 2026-02-27T08:30:00Z — Task #20 (follow graph minimal): delivered one atomic step by extending follow-target normalization to support X/Twitter profile URLs (`https://x.com/<handle>`, `twitter.com/<handle>`) before name/handle resolution, so follow edges are retained when upstream data stores full URLs. Validation: `node --check server.js` PASS + `grep -n "targetToken" server.js`. Proof: commit `<pending>`.
- 2026-02-27T08:15:00Z — Task #20 (follow graph minimal): delivered one atomic step by hardening follow-target resolution: `nodeByName` now indexes canonicalized keys (`String(node.name || '').trim().toLowerCase()`) and filters empty keys, improving edge matching when agent names include stray spaces. Validation: `node --check server.js` PASS + `grep -n "String(node.name || '')" server.js`. Proof: commit `<pending>`.
- 2026-02-27T07:30:00Z — Task #20 (follow graph minimal): delivered one atomic step by adding `GET /api/agents/follow-graph`, returning verified agent nodes and deduplicated follow edges resolved from `agent.following` entries (name or twitter handle). Validation: `node --check server.js` PASS + `grep -n "api/agents/follow-graph" server.js`. Proof: commit `9bca40f`.
- 2026-02-27T07:15:00Z — Task #19 (profile/projects production-ready): controlled no-op + escalation after 3 consecutive no-op/blocked cycles with no safe atomic delta identified; task moved to `blocked`, next ready task set to #20. Validation: `grep -n "canonicalAgentName\|encodedAgentName\|followCtaHtml" server.js`, `node --check server.js` PASS. Proof: explicit no-op with reason.
- 2026-02-27T07:00:00Z — Task #19 (profile/projects production-ready): controlled no-op; reran focused closure audit and found no additional safe atomic delta without widening scope. Validation: `grep -n "canonicalAgentName\|encodedAgentName\|followCtaHtml" server.js` (lines 846/847/855/902/923/1142/1145/1148), `node --check server.js` PASS. Proof: explicit no-op with reason.
- 2026-02-27T06:45:00Z — Task #19 (profile/projects production-ready): hardened profile link consistency by deriving both `safeAgentName` display and `encodedAgentName` href segments from canonical resolved identity (`agent.name`) instead of raw URL param; prevents inconsistent casing/whitespace from generating broken profile/project links. Validation: `node --check server.js` PASS. Proof: commit `0e38e96`.
- 2026-02-27T06:30:49Z — Task #19 (profile/projects production-ready): hardened followers parsing precision safety by clamping oversized digit strings (`length > 15`) directly to `Number.MAX_SAFE_INTEGER` before numeric conversion/display formatting. Validation: `node --check server.js` PASS. Proof: commit `71711b3`.
- 2026-02-27T06:00:00Z — Task #19 (profile/projects production-ready): hardened followers parsing to strict decimal digits-only after separator normalization to prevent ambiguous numeric formats from rendering misleading counts. Validation: `node --check server.js` PASS. Proof: commit `<pending>`.
- 2026-02-27T06:00:00Z — Task #19 (profile/projects production-ready): hardened follower parsing output by coercing valid numeric values to non-negative integers via `Math.floor` before compact display formatting, preventing fractional follower counts in production UI. Validation: `node --check server.js` PASS. Proof: git commit hash.
- 2026-02-27T05:45:00Z — Task #19 (profile/projects production-ready): controlled no-op; reran focused robustness checks and found no additional safe atomic delta without widening scope. Validation: `grep -n "normalizedFollowerCountRaw" server.js` (lines 876-877), `node --check server.js` PASS. Proof: explicit no-op with reason.
- 2026-02-27T05:30:00Z — Task #19 (profile/projects production-ready): hardened followers numeric parsing by normalizing commas/underscores/spaces before conversion; prevents valid string counts from collapsing to `0` in production rendering. Validation: `node --check server.js` PASS. Proof: commit `d6100fa`.
- 2026-02-27T05:15:00Z — Task #19 (profile/projects production-ready): extended compact followers formatting to support `x.xB` for values >=1,000,000,000 while preserving existing `M`/`K`/integer behavior; improves readability for ultra-high-volume profiles. Validation: `node --check server.js` PASS. Proof: commit `778a9ab`.
- 2026-02-27T04:45:00Z — Task #19 (profile/projects production-ready): extended profile followers display formatting with `x.xM` for values >=1,000,000 while preserving integer display for <1000 and `x.xK` for >=1000; improves readability for larger accounts. Validation: `node --check server.js` PASS. Proof: commit `e6818c1`.
- 2026-02-27T04:30:00Z — Task #19 (profile/projects production-ready): improved profile followers display formatting by showing integer counts for values <1000 and `x.xK` for >=1000; avoids misleading `0.0K` output in production. Validation: `node --check server.js` PASS. Proof: commit `2e86442`.
- 2026-02-27T03:45:23Z — Task #19 (profile/projects production-ready): controlled no-op; reran targeted robustness audit and found no additional safe atomic delta without widening scope. Validation: `grep -n "liveStatus" server.js` (no legacy occurrence, exit=1 expected), `grep -n "normalizedLiveStatus" server.js` (lines 860/861/862/1037/1139), `node --check server.js` PASS.
- 2026-02-27T03:30:33Z — Task #19 (profile/projects production-ready): controlled no-op; no safe incremental change found beyond prior 03:16Z fix. Validation: `grep -n "liveStatus" server.js` (no legacy variable reference), `grep -n "normalizedLiveStatus" server.js` (lines 860/861/862/1037/1139), `node --check server.js` PASS.
- 2026-02-27T03:16:02Z — Task #19 (profile/projects production-ready): fixed profile status indicator robustness by replacing undefined template variable `liveStatus` with `normalizedLiveStatus` at both status-dot render sites; validation: `node --check server.js` PASS.
- 2026-02-27T03:15:00Z — Task #19 (profile/projects production-ready): no-op contrôlé, pas de changement code; vérification de robustesse confirmée par `grep "const agentKey = Object.keys(agents).find(key => key.toLowerCase() === agentParam.toLowerCase())" server.js` (lignes 811/1174/1269) + `node --check server.js` PASS.
- 2026-02-27T03:00:00Z — Task #19 (profile/projects production-ready): no-op contrôlé, pas de changement code; audit de robustesse confirmé par `grep "agentKey = Object.keys(agents)..." server.js` (lignes 811/1174/1269) + `node --check server.js` PASS.
- 2026-02-27T02:45:55Z — Task #19 (profile/projects production-ready): hardened replay history timestamp formatting with invalid-date guard (`Number.isNaN(tsDate.getTime())`) and `Unknown time` fallback; validation: `node --check server.js` PASS.
- 2026-02-23T13:15:00Z — Task #19 (profile/projects production-ready): hardened `/live/:agentName/:projectId` injected context to use canonical resolved ids (`agent.name`, `project.id`) with trim instead of raw URL params; validation: `node --check server.js` PASS.
- 2026-02-23T13:00:00Z — Task #19 (profile/projects production-ready): hardened profile followers fallback by replacing random fallback with deterministic `0` when `agent.followers` is invalid/missing; validation: `node --check server.js` PASS.
- 2026-02-23T13:00:00Z — Task #19 (profile/projects production-ready): hardened `/api/agents/verify-tweet` by introducing `normalizedCode` and replacing `verificationCodes[code]` reads/deletes with `verificationCodes[normalizedCode]`; validation: `node --check server.js` PASS.
- 2026-02-23T12:45:00Z — Task #19 (profile/projects production-ready): hardened live route context bootstrap by replacing direct JS string interpolation with `projectContextJson = JSON.stringify(...).replace(/</g, '\\u003c')` before assigning `window.PROJECT_CONTEXT`; validation: `node --check server.js` PASS.
- 2026-02-23T11:30:00Z — Task #19 (profile/projects production-ready): hardened profile header external links by adding `rel="noopener noreferrer"` on `target="_blank"` links to X and GitHub; validation: `node --check server.js` PASS.
- 2026-02-23T11:15:00Z — Task #19 (profile/projects production-ready): hardened profile stats `Total Commits` by normalizing `agent.commits` to a safe integer (`commitsCount`) and replacing raw interpolation in template; validation: `node --check server.js` PASS.
- 2026-02-23T11:00:00Z — Task #19 (profile/projects production-ready): hardened profile date rendering by falling back to `Unknown` when `agent.created_at` parses to invalid date, preventing `Invalid Date` output in UI; validation: `node --check server.js` PASS.
- 2026-02-23T10:00:00Z — Task #19 (profile/projects production-ready): hardened project detail live CTA to prevent broken `/live/.../undefined` links by adding `projectIdRaw` trim + `#` fallback when `project.id` is absent; validation: `node --check server.js` PASS.
- 2026-02-23T09:45:53Z — Task #19 (profile/projects production-ready): hardened profile project cards to avoid broken `undefined` project links by deriving `projectHref` from trimmed project id and falling back to `#` when absent; validation: `node --check server.js` PASS.
- 2026-02-27 04:00Z — Task #19 (profile/projects production-ready): hardening CTA Follow profile; normalized+validated twitter_handle () before link creation, fallback  when invalid. Validation:  PASS.
- 2026-02-27 04:00Z — Task #19 (profile/projects production-ready): hardening CTA Follow profile; normalized+validated twitter_handle (`^[a-z0-9_]{1,15}$`) before link creation, fallback `#` when invalid. Validation: `node --check server.js` PASS.
- 2026-02-27 05:00Z — Task #19 (profile/projects production-ready): refined compact followers formatting to strip unnecessary trailing `.0` in K/M notations (e.g., `1.0K`→`1K`, `1.0M`→`1M`) while preserving meaningful decimals (`1.2K`). Validation: `node --check server.js` PASS. Proof: commit `db5ec7c`.
- 2026-02-27 06:15Z — Task #19 (profile/projects production-ready): no-op contrôlé; audit ciblé sur parsing followers strict déjà en place, aucun delta atomique sûr supplémentaire identifié sans élargir le scope. Validation: `grep -n "normalizedFollowerCountRaw\|isStrictNumericFollowers" server.js` (lignes 876-878) + `node --check server.js` PASS. Proof: explicit no-op with reason.
- 2026-02-27 06:30Z — Task #19 (profile/projects production-ready): no-op contrôlé; nouveau cycle d’audit, aucun delta atomique sûr additionnel trouvé sans dupliquer les hardenings followers déjà en place (strict parse + floor + cap `Number.MAX_SAFE_INTEGER`). Validation: `grep -n "normalizedFollowerCountRaw\|isStrictNumericFollowers\|Number.MAX_SAFE_INTEGER" server.js` (lignes 876-880) + `node --check server.js` PASS. Proof: explicit no-op with reason.
