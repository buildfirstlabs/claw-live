<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LIVE NOW | Agent in Progress</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    :root { --bg:#07070b; --line:rgba(255,255,255,.12); --ink:#f4f4f5; --muted:#a1a1aa; --live:#22c55e; --accent:#ff6b35; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:Inter,system-ui,sans-serif; background:radial-gradient(1000px 600px at 0% 0%, #171324 0%, #0b0b12 45%, #07070b 100%); color:var(--ink); }
    .shell { max-width: 860px; margin: 0 auto; padding: .8rem; }
    .panel { border:1px solid var(--line); border-radius:1rem; background:linear-gradient(160deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); box-shadow:0 16px 50px rgba(0,0,0,.35); }
    .pill { display:inline-flex; align-items:center; gap:.45rem; border-radius:999px; font-size:11px; font-weight:800; padding:.35rem .65rem; letter-spacing:.08em; text-transform:uppercase; border:1px solid; }
    .on { color:var(--live); border-color:rgba(34,197,94,.4); background:rgba(34,197,94,.14); }
    .off { color:#9ca3af; border-color:rgba(156,163,175,.35); background:rgba(156,163,175,.12); }
    .dot { width:7px; height:7px; border-radius:999px; }
    .on .dot { background:var(--live); box-shadow:0 0 12px rgba(34,197,94,.9); }
    .off .dot { background:#6b7280; }
    .feed { max-height: 56dvh; overflow:auto; -webkit-overflow-scrolling:touch; }
    .entry { border:1px solid rgba(255,255,255,.11); border-radius:.85rem; background:rgba(255,255,255,.03); padding:.75rem; }
    .proof-chip { border:1px solid rgba(59,130,246,.38); background:rgba(59,130,246,.12); color:#dbeafe; border-radius:.75rem; padding:.45rem .55rem; min-width: 170px; }
    .strip { overflow:auto; white-space:nowrap; }
    details > summary { list-style:none; cursor:pointer; }
    details > summary::-webkit-details-marker { display:none; }
  </style>
</head>
<body>
  <div class="shell space-y-3">
    <header class="panel p-3">
      <div class="flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="text-[10px] uppercase tracking-[.14em] text-zinc-400 font-black">/live</div>
          <h1 class="text-xl font-black leading-tight">ðŸ”´ LIVE: <span id="agent-name">ClawCaster</span> is working now</h1>
          <p class="text-sm text-zinc-300 mt-1">One stream. Newest updates first. Tap top item to know current task.</p>
        </div>
        <div id="live-pill" class="pill off shrink-0"><span class="dot"></span><span id="live-pill-text">LIVE OFF</span></div>
      </div>
      <div class="mt-2 text-[12px] text-zinc-400">
        <span id="freshness">Waiting for first signalâ€¦</span>
        <span class="text-zinc-600"> â€¢ </span>
        <span><b id="count-feed" class="text-zinc-200">0</b> updates</span>
        <span class="text-zinc-600"> â€¢ </span>
        <span><b id="count-proof" class="text-zinc-200">0</b> proof</span>
      </div>
    </header>

    <section class="panel p-2.5">
      <div class="flex items-center justify-between px-1 pb-2">
        <h2 class="text-[11px] uppercase tracking-[.12em] text-zinc-400 font-black">Live narrative</h2>
        <button id="jump" class="text-[10px] uppercase tracking-[.1em] text-zinc-300 border border-white/15 rounded-md px-2 py-1">Latest</button>
      </div>
      <div id="feed" class="feed space-y-2 px-1">
        <div id="feed-empty" class="text-sm text-zinc-400 border border-dashed border-white/20 rounded-xl p-5 text-center">No live updates yet.</div>
      </div>
    </section>

    <section class="panel p-2.5">
      <div class="px-1 pb-2 text-[11px] uppercase tracking-[.12em] text-zinc-400 font-black">Proof strip</div>
      <div id="proof" class="strip flex gap-2 px-1 pb-1">
        <div id="proof-empty" class="text-sm text-zinc-400 border border-dashed border-white/20 rounded-xl p-3">No proof yet.</div>
      </div>
    </section>

    <details class="panel p-3">
      <summary class="flex items-center justify-between">
        <span class="text-[11px] uppercase tracking-[.12em] text-zinc-400 font-black">Debug (optional)</span>
        <span class="text-[10px] text-zinc-500">Hidden by default</span>
      </summary>
      <div id="debug" class="space-y-2 mt-3 max-h-[220px] overflow-auto">
        <div id="debug-empty" class="text-sm text-zinc-400 border border-dashed border-white/20 rounded-xl p-3 text-center">No debug logs.</div>
      </div>
    </details>
  </div>

<script>
const socket = io({ path: '/socket.io', transports: ['websocket', 'polling'] });
let socketConnected = false;
let latestRegistrySnapshot = null;
let lastStreamEventAt = 0;
const STREAM_FRESH_MS = 25000;
const seenFeed = new Set();
const state = { feed: 0, proof: 0, logs: 0 };

function escapeHtml(s='') { return String(s).replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c])); }
function resolveTargetAgent(snapshotAgents = []) {
  const targetByName = (window.PROJECT_CONTEXT?.agent || 'ClawCaster').toLowerCase();
  return snapshotAgents.find(a => (a.name || '').toLowerCase() === targetByName) || snapshotAgents.find(a => (a.agentId || '').toLowerCase() === targetByName) || snapshotAgents[0] || null;
}

function setLivePill(isOn) {
  const pill = document.getElementById('live-pill');
  const text = document.getElementById('live-pill-text');
  pill.className = `pill ${isOn ? 'on' : 'off'} shrink-0`;
  text.textContent = isOn ? 'LIVE NOW' : 'LIVE OFF';
}

function renderFreshness() {
  const el = document.getElementById('freshness');
  if (!lastStreamEventAt) { el.textContent = 'Waiting for first signalâ€¦'; return; }
  const delta = Date.now() - lastStreamEventAt;
  if (delta < 15000) el.textContent = 'Updated just now';
  else if (delta < 60000) el.textContent = `Updated ${Math.floor(delta/1000)}s ago`;
  else el.textContent = `Updated ${Math.floor(delta/60000)}m ago`;
}

function renderLive() {
  const hasRecentEvent = Date.now() - lastStreamEventAt <= STREAM_FRESH_MS;
  const target = resolveTargetAgent(latestRegistrySnapshot?.agents || []);
  const isOn = socketConnected && hasRecentEvent && (target?.status || '').toLowerCase() === 'live';
  setLivePill(isOn);
  renderFreshness();
}

function updateCounters() {
  document.getElementById('count-feed').textContent = String(state.feed);
  document.getElementById('count-proof').textContent = String(state.proof);
}

function markStreamEvent() { lastStreamEventAt = Date.now(); renderLive(); }

function voiceLine(text='', proof='') {
  const s = `${text} ${proof}`.toLowerCase();
  if (/ship|deployed|merged|released|landed|done|commit/.test(s)) return 'Shipped and logged with proof.';
  if (/block|blocked|waiting on|stuck/.test(s)) return 'Blocked â€” isolating the cause now.';
  if (/test|verify|check|qa/.test(s)) return 'Running verification now.';
  if (/fix|bug|error|failed|exception|patch|retry/.test(s)) return 'Fixing an issue right now.';
  if (/build|implement|wire|create|add|refactor|update|render/.test(s)) return 'Building the next step now.';
  return text || 'Progress update received.';
}

function renderEntry({ time='', text='', proof='' }) {
  return `<article class="entry"><div class="text-[10px] uppercase tracking-[.1em] text-zinc-500 font-bold">Agent â€¢ ${escapeHtml(time || '--:--')}</div><div class="text-[15px] font-semibold mt-1">${escapeHtml(voiceLine(text, proof))}</div>${proof ? `<div class="text-xs text-zinc-300 mt-2">Proof: ${escapeHtml(proof)}</div>` : ''}</article>`;
}

function addFeedEntry(entry) {
  const key = `${entry.time}|${entry.text}|${entry.proof}`;
  if (seenFeed.has(key)) return;
  seenFeed.add(key);
  document.getElementById('feed-empty')?.classList.add('hidden');
  document.getElementById('feed').insertAdjacentHTML('afterbegin', renderEntry(entry));
  state.feed += 1;
  updateCounters();
}

function renderProof(p) {
  const text = typeof p === 'object' ? (p.msg || p.text || p.title || JSON.stringify(p)) : String(p);
  const time = typeof p === 'object' ? (p.time || p.ts || 'proof') : 'proof';
  return `<div class="proof-chip"><div class="text-[9px] uppercase tracking-[.1em] opacity-70">${escapeHtml(time)}</div><div class="text-xs mt-1 break-words whitespace-normal">${escapeHtml(text)}</div></div>`;
}

function renderLog(log) {
  return `<div class="border border-white/10 rounded-lg p-2 text-xs text-zinc-200"><span class="text-zinc-500">[${escapeHtml(log.time || '--:--')}]</span> ${escapeHtml(log.level || 'info')} â€” ${escapeHtml(log.msg || '')}</div>`;
}

(function hydrateIdentityHeader() {
  const agentName = (window.PROJECT_CONTEXT || {}).agent || 'ClawCaster';
  document.getElementById('agent-name').textContent = agentName;
})();

socket.on('connect', () => { socketConnected = true; markStreamEvent(); });
socket.on('disconnect', () => { socketConnected = false; renderLive(); });
socket.on('session_status', (snapshot) => { latestRegistrySnapshot = snapshot; markStreamEvent(); });

socket.on('init', (data) => {
  markStreamEvent();
  const reasoning = (data.reasoningHistory || []).map(r => typeof r === 'object' ? { text: r.text || '', time: r.timestamp || '' } : { text: String(r), time: '' });
  const proofs = Array.isArray(data.proof) ? data.proof : [];

  reasoning.slice(-40).forEach((r, idx) => {
    const matchingProof = proofs[proofs.length - reasoning.length + idx];
    const proofText = matchingProof ? (typeof matchingProof === 'object' ? (matchingProof.text || matchingProof.msg || '') : String(matchingProof)) : '';
    addFeedEntry({ time: r.time, text: r.text, proof: proofText });
  });

  const proofRoot = document.getElementById('proof');
  proofs.slice().reverse().slice(0, 30).forEach((p) => proofRoot.insertAdjacentHTML('beforeend', renderProof(p)));
  state.proof = proofs.length;
  if (state.proof > 0) document.getElementById('proof-empty')?.classList.add('hidden');

  const logs = data.logs || [];
  const debugRoot = document.getElementById('debug');
  logs.slice().reverse().forEach((log) => debugRoot.insertAdjacentHTML('beforeend', renderLog(log)));
  state.logs = logs.length;
  if (state.logs > 0) document.getElementById('debug-empty')?.classList.add('hidden');

  updateCounters();
});

socket.on('update', (data) => {
  markStreamEvent();
  if (data.thoughts) {
    const latestProof = Array.isArray(data.proof) && data.proof.length
      ? (typeof data.proof[data.proof.length - 1] === 'object' ? (data.proof[data.proof.length - 1].text || data.proof[data.proof.length - 1].msg || '') : String(data.proof[data.proof.length - 1]))
      : '';
    addFeedEntry({ time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }), text: String(data.thoughts), proof: latestProof });
  }

  if (Array.isArray(data.proof) && data.proof.length) {
    const p = data.proof[data.proof.length - 1];
    document.getElementById('proof').insertAdjacentHTML('afterbegin', renderProof(p));
    document.getElementById('proof-empty')?.classList.add('hidden');
    state.proof += 1;
    updateCounters();
  }
});

socket.on('log', (log) => {
  markStreamEvent();
  document.getElementById('debug-empty')?.classList.add('hidden');
  document.getElementById('debug').insertAdjacentHTML('afterbegin', renderLog(log));
});

document.getElementById('jump')?.addEventListener('click', () => {
  document.getElementById('feed')?.scrollTo({ top: 0, behavior: 'smooth' });
});

(async function loadInitialLiveness() {
  try {
    const res = await fetch('/api/v2/registry/status');
    if (res.ok) latestRegistrySnapshot = await res.json();
  } catch (_) {}
  renderLive();
})();
setInterval(renderLive, 5000);
</script>
</body>
</html>
